# ISA-95 to Battery DPP Mapping
# Maps B2MML production data to Digital Product Passport format

mapping:
  name: "ISA-95 to Battery DPP"
  version: "1.0.0"
  description: "Transform B2MML production data to Battery Passport"
  
  source:
    connector: isa95
    root: MaterialLot
    
  target:
    schema: dpp
    format: jsonld

rules:
  # General Product Information
  - source: "MaterialLot/ID"
    target: "generalProductInformation.productIdentifier"
    required: true

  - source: "MaterialLot/Property[@ID='manufacturer']/Value"
    target: "generalProductInformation.manufacturerInformation.identifier"
    required: true

  - source: "MaterialLot/Property[@ID='manufacturer_name']/Value"
    target: "generalProductInformation.manufacturerInformation.contactName"
    default: "Unknown Manufacturer" # Default if missing
  
  - source: "MaterialLot/Property[@ID='manufacturer_email']/Value"
    target: "generalProductInformation.manufacturerInformation.emailAddress"
    default: "info@example.com"



  # General Product Info (Mass)
  - source: "MaterialLot/Property[@ID='weight_kg']/Value"
    target: "generalProductInformation.batteryMass"
    transform:
      type: float

  # Material Composition
  - source: "MaterialLot/MaterialDefinitionID"
    target: "materialComposition.batteryChemistry.clearName"
    transform:
      type: lookup
      table:
        MAT-NMC811: "Lithium Nickel Manganese Cobalt Oxide (NMC 811)"
        MAT-LFP: "Lithium Iron Phosphate (LFP)"
        MAT-NCA: "Lithium Nickel Cobalt Aluminum Oxide (NCA)"
      default: "Unknown Chemistry"
      
  - source: "MaterialLot/MaterialDefinitionID"
    target: "materialComposition.batteryChemistry.shortName"
    transform:
      type: lookup
      table:
        MAT-NMC811: "NMC"
        MAT-LFP: "LFP"
        MAT-NCA: "NCA"
      default: "Other"

  # Required fields placeholders (to satisfy validation for demo)
  # These would normally come from data or be more complex constants
  - source: "MaterialLot/ID" # Dummy source
    target: "generalProductInformation.batteryPassportIdentifier"
    transform:
        type: template
        template: "urn:batterypass:example"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.batteryCategory"
    transform:
        type: template
        template: "ev"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.batteryStatus"
    transform:
        type: template
        template: "Original"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.manufacturingDate"
    transform:
        type: template
        template: "2024-01-01T00:00:00Z"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.manufacturingPlace.addressCountry"
    transform:
        type: template
        template: "DE"
  
  - source: "MaterialLot/ID"
    target: "generalProductInformation.manufacturerInformation.postalAddress.addressCountry"
    transform:
        type: template
        template: "DE"
  
  - source: "MaterialLot/ID"
    target: "generalProductInformation.manufacturerInformation.postalAddress.postalCode"
    transform:
        type: template
        template: "12345"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.manufacturerInformation.postalAddress.streetAddress"
    transform:
        type: template
        template: "Main St"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.manufacturingPlace.postalCode"
    transform:
        type: template
        template: "12345"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.manufacturingPlace.streetAddress"
    transform:
        type: template
        template: "Factory St"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.operatorInformation.contactName"

    transform:
        type: template
        template: "ACME Ops"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.operatorInformation.identifier"
    transform:
        type: template
        template: "OPS-001"
  
  - source: "MaterialLot/ID"
    target: "generalProductInformation.operatorInformation.postalAddress.addressCountry"
    transform:
        type: template
        template: "DE"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.operatorInformation.postalAddress.postalCode"
    transform:
        type: template
        template: "54321"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.operatorInformation.postalAddress.streetAddress"
    transform:
        type: template
        template: "Ops Lane"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.puttingIntoService"
    transform:
        type: template
        template: "2024-02-01T00:00:00Z"

  - source: "MaterialLot/ID"
    target: "generalProductInformation.warrentyPeriod"
    transform:
        type: template
        template: "--12"

  # Carbon Footprint (Dummy Data)
  - source: "MaterialLot/ID"
    target: "carbonFootprint.batteryCarbonFootprint"
    transform:
        type: template
        template: "50.0" 

  - source: "MaterialLot/ID"
    target: "carbonFootprint.carbonFootprintPerformanceClass"
    transform:
        type: template
        template: "A"

  - source: "MaterialLot/ID"
    target: "carbonFootprint.carbonFootprintStudy"
    transform:
        type: template
        template: "https://example.com"
  
  - source: "MaterialLot/ID"
    target: "carbonFootprint.carbonFootprintPerLifecycleStage"
    # This is a list. Mapping engine might struggle to create lists from single templates.
    # I might need to skip full validation of complex nested lists in this simple demo or
    # create a simplified mapping that satisfies the model structure.
    # The error said "Field required".
    # I can try to pass a JSON string and have a custom transform parse it? 
    # Or just ignore it for now and verify 'carbonFootprint' existence? 
    # No, Pydantic validation is strict.
    # I'll try to map one item to index 0?
    # target: "carbonFootprint.carbonFootprintPerLifecycleStage[0].lifecycleStage"
    # Does the bridge support list indexing? 'mapping/engine.py' likely does 'set_value(target, value)'.
    # If it supports dot notation with list indices, great. If not, I'm stuck.
    # Let's try dot notation and see.
    target: "carbonFootprint.carbonFootprintPerLifecycleStage.0.lifecycleStage"
    transform:
        type: template
        template: "RawMaterialExtraction"

  - source: "MaterialLot/ID"
    target: "carbonFootprint.carbonFootprintPerLifecycleStage.0.carbonFootprint"
    transform:
        type: template
        template: "10.0"
  
  # Circularity (Dummy Data)
  - source: "MaterialLot/ID"
    target: "circularity.renewableContent"
    transform:
        type: template
        template: "10.0"

  - source: "MaterialLot/ID"
    target: "circularity.dismantlingAndRemovalInformation.0.documentType"
    transform:
         type: template
         template: "DismantlingManual"
  - source: "MaterialLot/ID"
    target: "circularity.dismantlingAndRemovalInformation.0.mimeType"
    transform:
         type: template
         template: "application/pdf"
  - source: "MaterialLot/ID"
    target: "circularity.dismantlingAndRemovalInformation.0.documentURL"
    transform:
         type: template
         template: "https://example.com"

  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.nameOfSupplier"
    transform:
         type: template
         template: "SparePartsCo"
         
  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.addressOfSupplier.addressCountry"
    transform:
         type: template
         template: "DE"
  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.addressOfSupplier.postalCode"
    transform:
         type: template
         template: "12345"
  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.addressOfSupplier.streetAddress"
    transform:
         type: template
         template: "Spare St"
  
  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.emailAddressOfSupplier"
    transform:
         type: template
         template: "spares@example.com"
  
  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.supplierWebAddress"
    transform:
         type: template
         template: "https://example.com"

  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.components.0.partName"
    transform:
         type: template
         template: "Part A"
  - source: "MaterialLot/ID"
    target: "circularity.sparePartSources.0.components.0.partNumber"
    transform:
         type: template
         template: "123"

  - source: "MaterialLot/ID"
    target: "circularity.recycledContent.0.preConsumerShare"
    transform:
         type: template
         template: "5.0"
  - source: "MaterialLot/ID"
    target: "circularity.recycledContent.0.recycledMaterial"
    transform:
         type: template
         template: "Cobalt"
  - source: "MaterialLot/ID"
    target: "circularity.recycledContent.0.postConsumerShare"
    transform:
         type: template
         template: "5.0"
  
  - source: "MaterialLot/ID"
    target: "circularity.endOfLifeInformation.wastePrevention"
    transform:
         type: template
         template: "https://example.com"
  - source: "MaterialLot/ID"
    target: "circularity.endOfLifeInformation.separateCollection"
    transform:
         type: template
         template: "https://example.com"
  - source: "MaterialLot/ID"
    target: "circularity.endOfLifeInformation.informationOnCollection"
    transform:
         type: template
         template: "https://example.com"
         
  - source: "MaterialLot/ID"
    target: "circularity.safetyMeasures.safetyInstructions"
    transform:
         type: template
         template: "https://example.com"
  - source: "MaterialLot/ID"
    target: "circularity.safetyMeasures.extinguishingAgent.0"
    transform:
         type: template
         template: "Water"

  # Material Composition Lists
  - source: "MaterialLot/ID"
    target: "materialComposition.batteryMaterials.0.batteryMaterialLocation.componentName"
    transform:
         type: template
         template: "Cathode"
  - source: "MaterialLot/ID"
    target: "materialComposition.batteryMaterials.0.batteryMaterialIdentifier"
    transform:
         type: template
         template: "12-34-5"
  - source: "MaterialLot/ID"
    target: "materialComposition.batteryMaterials.0.batteryMaterialName"
    transform:
         type: template
         template: "Lithium"
  - source: "MaterialLot/ID"
    target: "materialComposition.batteryMaterials.0.batteryMaterialMass"
    transform:
         type: template
         template: "10.0"
  - source: "MaterialLot/ID"
    target: "materialComposition.batteryMaterials.0.isCriticalRawMaterial" # Bool coercion from string 'true'?
    transform:
         type: template
         template: "true"

  - source: "MaterialLot/ID"
    target: "materialComposition.hazardousSubstances.0.hazardousSubstanceClass"
    transform:
         type: template
         template: "AcuteToxicity"
  - source: "MaterialLot/ID"
    target: "materialComposition.hazardousSubstances.0.hazardousSubstanceName"
    transform:
         type: template
         template: "Lead"
  - source: "MaterialLot/ID"
    target: "materialComposition.hazardousSubstances.0.hazardousSubstanceConcentration"
    transform:
         type: template
         template: "0.5"
  - source: "MaterialLot/ID"
    target: "materialComposition.hazardousSubstances.0.hazardousSubstanceImpact.0"
    transform:
         type: template
         template: "Toxic"
  - source: "MaterialLot/ID"
    target: "materialComposition.hazardousSubstances.0.hazardousSubstanceLocation.componentName"
    transform:
         type: template
         template: "Terminal"
  - source: "MaterialLot/ID"
    target: "materialComposition.hazardousSubstances.0.hazardousSubstanceIdentifier"
    transform:
         type: template
         template: "7439-92-1"




